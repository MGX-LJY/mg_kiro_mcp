# mg_kiro MCP Server 测试策略

## 🎯 测试目标
- **覆盖率目标**: 从20%提升到85%+
- **质量目标**: 确保核心功能稳定可靠
- **回归目标**: 防止功能退化和破坏性变更

## 📋 测试分层架构

### 1. 单元测试层 (Unit Tests)
**目标覆盖**: 70%
**测试范围**: 独立模块和函数逻辑

#### 优先级P0 - 核心服务器
- **server/mcp-server.js** (800行代码)
  - API端点功能测试 (8个端点)
  - WebSocket连接管理测试
  - 中间件堆栈测试
  - 错误处理测试
  - 连接和状态管理测试

#### 优先级P1 - 业务逻辑核心
- **server/mode-handler.js** (600行代码)
  - 四种模式处理器测试
  - 状态机转换测试
  - 模式间切换测试
  - 业务逻辑验证测试

- **server/prompt-manager.js** (400行代码)
  - 文件加载和缓存测试
  - 模板变量替换测试
  - 热重载机制测试
  - 版本控制测试

#### 优先级P2 - 智能功能
- **server/language/detector.js** (400行代码)
  - 6种语言识别准确性测试
  - 框架检测测试
  - 权重算法测试
  - 边界情况测试

- **server/language/template-generator.js** (500行代码)
  - 模板生成功能测试
  - 语言特定变量注入测试
  - 回退机制测试
  - 批量生成测试

### 2. 集成测试层 (Integration Tests)
**目标覆盖**: 15%
**测试范围**: 模块间协作和数据流

- MCP服务器 + 提示词管理器集成
- 模式处理器 + 模板生成器集成
- 语言检测 + 模板生成完整流程
- 配置系统 + 各模块集成

### 3. API测试层 (API Tests)
**目标覆盖**: 10%
**测试范围**: HTTP接口和WebSocket通信

- RESTful API端点测试
- WebSocket实时通信测试
- MCP协议握手测试
- 错误响应和状态码测试

### 4. 端到端测试层 (E2E Tests)
**目标覆盖**: 5%
**测试范围**: 完整用户场景

- 项目初始化完整流程
- 模式切换和文档生成流程
- 语言检测到模板生成流程
- Claude Code集成场景测试

## 🔧 测试技术栈

### 测试框架
- **自制TestRunner** - 已实现完整的测试运行器
- **断言系统** - Expectation类提供丰富断言
- **Mock系统** - 需要实现模块Mock功能

### 测试工具
- **文件系统Mock** - 用于测试文件操作
- **HTTP请求Mock** - 用于测试API端点
- **WebSocket Mock** - 用于测试实时通信
- **时间Mock** - 用于测试缓存和超时

### 覆盖率工具
- **手动统计** - 基于测试用例覆盖情况
- **执行路径追踪** - 记录代码执行路径

## 📊 测试实施计划

### 第一阶段 - MCP服务器测试 (1-2天)
- [ ] 创建完整的server.test.js
- [ ] 实现8个API端点测试
- [ ] 实现WebSocket通信测试
- [ ] 实现错误处理测试
- **预期提升覆盖率**: +30%

### 第二阶段 - 核心业务逻辑测试 (2-3天)
- [ ] 创建完整的modes.test.js
- [ ] 实现四种模式处理器测试
- [ ] 创建prompt-manager.test.js
- [ ] 实现缓存和热重载测试
- **预期提升覆盖率**: +25%

### 第三阶段 - 智能功能测试 (2天)
- [ ] 创建language-detector.test.js
- [ ] 创建template-generator.test.js
- [ ] 实现语言识别准确性测试
- [ ] 实现模板生成功能测试
- **预期提升覆盖率**: +20%

### 第四阶段 - 集成和端到端测试 (1-2天)
- [ ] 创建integration.test.js
- [ ] 创建e2e.test.js
- [ ] 实现完整流程测试
- **预期提升覆盖率**: +10%

## 🎯 质量标准

### 测试质量要求
- **断言覆盖**: 每个测试至少3个断言
- **边界测试**: 覆盖正常、异常、边界情况
- **错误测试**: 每个模块至少5个错误场景测试
- **性能测试**: 关键路径性能基准测试

### 代码质量要求
- **测试可读性**: 清晰的测试描述和注释
- **测试独立性**: 测试间无相互依赖
- **数据隔离**: 每个测试使用独立数据
- **清理机制**: 测试后完整资源清理

## 🚦 测试执行策略

### 快速反馈循环
```bash
# 快速单元测试 (< 30秒)
npm run test:unit

# 完整测试套件 (< 2分钟)
npm test

# 覆盖率报告
npm run test:coverage
```

### 测试数据管理
- **Mock数据**: 统一的测试数据工厂
- **临时文件**: 自动清理的临时测试文件
- **环境隔离**: 测试专用配置和环境

### 持续集成
- **预提交钩子**: 运行快速测试
- **CI流水线**: 完整测试 + 覆盖率检查
- **质量门禁**: 85%覆盖率 + 0失败测试

## 📈 成功指标

### 定量指标
- **代码覆盖率**: 85%+
- **测试通过率**: 100%
- **测试执行时间**: < 2分钟
- **Bug检测率**: 90%+

### 定性指标
- **测试可维护性**: 容易理解和修改
- **测试可靠性**: 稳定且一致的结果
- **开发效率**: 快速定位问题
- **回归保护**: 有效防止功能退化

---
*测试策略文档 v1.0 | 更新时间: 2024-09-06*