# file-query-service.js 技术分析

## 概述
文件查询服务是一个核心服务模块，提供项目文件的智能查询、分析和内容处理能力。该服务支持文件树查询、智能分类、重要性排序以及内容预览功能。

## 核心功能模块

### 1. TokenCalculator (Token计算器)
**职责**: 提供准确的文本和代码token估算
**特性**:
- 支持中英文混合文本的智能token估算
- 针对不同编程语言优化的token密度计算
- 多模型token限制管理(Claude-3, GPT-4, GPT-3.5等)
- 安全阈值控制，预留缓冲区防止超限

**关键方法**:
- `estimateTokens()`: 基础文本token估算，区分中英文字符
- `estimateCodeTokens()`: 代码专用token计算，考虑语言特性
- `exceedsLimit()`: 检查是否超出模型token限制
- `calculateChunks()`: 计算最优分片数量

### 2. SmartChunker (智能分片器)
**职责**: 实现文件内容的智能分片处理
**核心算法**:
- 超小分片策略: 每片最多1500 tokens，约4800字符
- 行级别分片: 保持代码结构完整性
- 重叠机制: 200 token重叠确保上下文连贯性
- 动态分片: 根据内容复杂度自适应调整

**分片策略**:
```javascript
maxCharsPerChunk = Math.min(4800, maxTokens * 4)
safeTokenLimit = tokenLimit * 0.6  // 60%安全阈值
```

## 技术特色

### 1. 多语言支持
- JavaScript/TypeScript: 0.8倍token密度
- Python: 0.75倍token密度  
- JSON: 0.9倍token密度
- Markdown: 0.7倍token密度

### 2. 智能文本处理
- 中文字符识别: 使用Unicode范围`[\\u4e00-\\u9fff]`
- 中文token密度: 0.6倍字符数
- 英文token密度: 0.25倍字符数

### 3. 安全机制
- 多级安全阈值: 80%检查阈值，60%实际使用阈值
- 分片重叠保护: 防止上下文丢失
- 字符长度双重验证: token估算 + 字符数限制

## 架构优势

### 1. 模块化设计
- 独立的Token计算器，可复用于其他服务
- 分片器与计算器解耦，便于扩展和测试
- 清晰的职责分离，符合单一职责原则

### 2. 性能优化
- 基于字符数的快速预判，避免复杂token计算
- 行级处理，减少内存占用
- 分片元数据丰富，支持快速定位

### 3. 扩展性
- 支持多种AI模型的token限制
- 可配置的分片策略
- 语言特性可扩展

## 代码质量评估

**优点**:
- 完整的JSDoc文档
- 清晰的类和方法命名
- 合理的错误处理和边界检查
- 良好的代码注释和说明

**改进建议**:
- 可考虑添加单元测试覆盖
- 配置文件外置，提高可配置性
- 添加性能监控和日志

## 依赖关系
- 使用Node.js fs模块进行文件操作
- 使用path模块处理文件路径
- 纯JavaScript实现，无外部依赖

## 使用场景
- 项目文件分析和索引
- 大文件内容的智能分片
- AI模型input准备和预处理
- 文档生成系统的内容管理