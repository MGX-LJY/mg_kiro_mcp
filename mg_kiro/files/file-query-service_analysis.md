# 文件查询服务 (file-query-service.js) 分析文档

## 概述
文件查询服务是一个核心服务，为AI提供项目文件信息查询能力，包括文件树查询、详细信息获取、智能分类和内容预览等功能。

## 核心组件

### 1. TokenCalculator 类
**功能**: Token计算和管理工具类

**核心方法**:
- `estimateTokens(text)`: 估算文本token数量，支持中英文差异化计算
- `estimateCodeTokens(code, language)`: 针对代码的token估算，考虑语言特性
- `exceedsLimit(tokens, model)`: 检查是否超过模型token限制
- `calculateChunks(tokens, model)`: 计算所需分片数量

**技术特点**:
- 支持多种AI模型的token限制 (Claude-3: 200k, GPT-4: 128k等)
- 中文字符token密度更高 (0.6 vs 0.25)
- 代码token密度相对较低 (0.75-0.9倍)
- 预留20%安全缓冲区

### 2. SmartChunker 类
**功能**: 智能内容分片处理器

**核心特性**:
- 超小分片处理策略，确保每个分片在MCP限制内 (maxTokens = 1500)
- 基于字符数和行数的双重分片逻辑
- 分片重叠机制 (200 tokens overlap)
- 保持代码结构完整性

**分片算法**:
- 小文件: 直接返回完整内容 (<=6000字符且<=1500 tokens)
- 大文件: 按4800字符/分片进行切割，保持行完整性
- 每个分片包含详细元数据 (行号、token数、摘要等)

## 架构设计

### 服务定位
- 为项目分析和AI交互提供文件查询能力
- 作为底层基础服务支撑上层业务逻辑
- 处理大文件时的智能分片和token管理

### 设计模式
- 工具类模式: TokenCalculator 和 SmartChunker 独立封装
- 分层架构: 计算层 -> 分片层 -> 服务层
- 策略模式: 不同语言和模型的差异化处理

### 技术决策
- 保守的token估算策略，确保不超限
- 基于字符数的快速分片算法
- 支持多种AI模型的适配能力

## 使用场景
1. 项目初始化时的文件扫描和分析
2. AI对话中的文件内容查询
3. 大型文件的智能分片处理
4. Token限制下的内容管理

## 优化建议
1. 考虑添加缓存机制，避免重复计算
2. 支持更多编程语言的token密度优化
3. 实现动态分片策略，根据内容类型调整
4. 添加分片质量评估和优化机制